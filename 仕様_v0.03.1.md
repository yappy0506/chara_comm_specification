# 仕様書 v03.1

## 1. コンセプト
LLMに特定のキャラクターを演じさせ、Playerと対話する  
**CUIベースの会話型アプリケーション**を構築する。

本アプリケーションは、将来的にGUI化・ゲームエンジン連携・感情モデル導入などの拡張を前提とした  
**拡張可能なコア会話システム**を目的とする。

---

## 2. 動作環境・使用技術

### 2.1 動作環境
- OS：Windows（他OSは将来検討）
- 実行形態：ローカル実行

### 2.2 使用技術
- 言語：Python
- LLM制御：LangChain
- 推論サーバ：LM Studio
- 使用モデル：`openai/gpt-oss-20b`（LM Studio上で起動）

---

## 3. システム概要

- インタフェースは **CUI（コンソール）** とする
- ユーザー入力1回につき、LLMから1回応答を生成する
- 会話はセッション単位で管理される
- キャラクター設定は外部ファイルとして管理し、System Promptへ反映する

---

## 4. キャラクター設定管理

### 4.1 キャラクター設定ファイル
- キャラクター設定は **外部ファイル** として管理する
- ファイル形式：`Markdown / YAML / JSON`（※最終決定は実装時）
- 読み込む内容の例：
  - キャラクターの人格・性格
  - 口調
  - 一人称
  - 禁止事項（メタ発言禁止、システム言及禁止など）

### 4.2 プロンプト反映方針
- キャラクター設定ファイルの内容は **System Prompt** に反映する
- System Promptは以下の構造を想定する：
  1. キャラクター設定
  2. 行動・発話制約（禁止事項）
  3. 出力ルール（キャラクターとして発話すること）

---

## 5. 会話履歴管理

### 5.1 会話履歴の分類
会話履歴は以下の2種類を持つ。

#### (1) LLM投入履歴（短期記憶）
- LLMへ毎回送信する会話履歴
- 保持範囲：
  - 直近 **Nターン**（プレースホルダ：`N = 100`）
  - またはトークン上限に収まる範囲
- 上限を超えた場合、古い履歴から破棄する

#### (2) 保存ログ（永続記憶）
- 全会話履歴をローカルへ永続保存する
- 保存形式：**SQLite**
- 各ターンごとに逐次保存する

### 5.2 保存ログの容量制限
- 保存ログには容量制限を設ける
- 制限方式（プレースホルダ）：
  - 最大セッション数：`MAX_SESSION_COUNT = XXX`
- 上限を超えた場合：
  - 古いセッションから順に削除する

---

## 6. セッションとコマンド仕様

### 6.1 セッション管理
- 会話はセッションID単位で管理する
- `/new` 実行時に新しいセッションIDを発行する

### 6.2 コマンド一覧

| コマンド | 内容 |
|--------|------|
| `/exit` | アプリケーションを終了する（必要に応じて保存後終了） |
| `/reset` | **LLM投入履歴のみ**をクリアする（保存ログ・セッションIDは維持） |
| `/new` | 新しいセッションを開始する |
| `/save` | 手動で保存処理を実行する（任意） |

---

## 7. 入出力仕様

### 7.1 入力
- CUIからの **1行入力**
- 将来GUI化時に複数行入力対応を想定

### 7.2 出力
- CUIには **キャラクターの発話テキストのみ**を表示する
- 内部的には以下のような構造化データを扱える設計とする：

```json
{
  "utterance": "発話内容",
  "emotion": {},
  "actions": []
}
```

※ 現時点では `utterance` のみを使用する

---

## 8. LM Studio 接続仕様

- LM Studioが提供する **OpenAI互換API** へHTTP接続する
- 接続前にヘルスチェックを行う

### 8.1 接続不可時の挙動
- LM Studioの自動起動・自動サーバ有効化は **ベストエフォート** とする
- 接続できない場合は以下を行う：
  - 起動状態・サーバ有効化状態を判定
  - 必要な手順をユーザーへ表示
  - アプリケーションは終了せず、復帰可能とする

---

## 9. エラー処理方針

- LLMによる生成がタイムアウトした場合：
  - エラーメッセージを表示し、入力待ち状態に戻る
- プロンプトまたは会話履歴がトークン上限を超過した場合：
  - 古い履歴から順に破棄する
- 想定外の例外が発生した場合：
  - 可能な限りエラーメッセージを表示し、アプリケーションの継続を試みる
- 致命的エラーが発生した場合：
  - 状況を表示した上で安全に終了する

---

## 10. 実装方針

- コードは **機能単位で分割**する
- モジュール間の依存関係は一方向とし、循環依存を避ける
- 想定モジュール例
  - UI層（CUI）
  - 入力処理・コマンド解釈
  - セッション管理
  - 会話制御（オーケストレーション）
  - プロンプト生成
  - LLM接続（LM Studio API）
  - ログ管理（SQLite）

---

## 11. 今後の拡張予定（本仕様では実装しない）

- 感情パラメータの導入
- 無言・入力中状態を考慮した自律発話
- GUI化
- Unityとの統合
- 長期記憶（検索・要約を伴う）
- 会話中の設定蓄積
- キャラクター過去エピソード管理
- マルチモーダル入力（画像対応）
- 複数人との並列会話
- キャラクター表示との連動