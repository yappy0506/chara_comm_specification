# 仕様書

## コンセプト
LLMにキャラクターを演じさせ、playerと対話いてもらう会話型アプリケーション

## 環境
 * 動作PC
    * windows
 * 使用ツール
    * python
    * langchain
    * lmstudio(openai/gpt-oss-20b)

## 仕様
 * キャラクターの設定参照システム
    * キャラクター設定は外部ファイルを参照の上、システムプロンプトに反映させる
    * 「口調」「一人称」「禁止事項（メタ発言禁止等）」も外部ファイルを参照の上、システムプロンプトに反映させる
 * 会話履歴
    * 実行中はメモリ保持 + 終了時（または逐次）にファイル保存
    * 「保存ログ」は全履歴をローカルへ永続保存する。ただし容量に制限を設け、容量を超えた場合は過去のデータから消していくものとする。
    * 「LLM投入履歴」は直近Nターン（暫定100）またはトークン上限に収まる範囲とする。
    * /reset は「LLM投入履歴」をクリアし、保存ログは維持する（または新セッション開始とする）。
    * 保存形式はSQLite（将来検索に強い）
 * インタフェース
    * core機能
       * CUI
       * 入力に対し、1回返答を行う。
    * 入出力
       * 入力は1行(将来、GUI変更時に複数行対応)
       * 出力はキャラクターが発話のみ
       * 内部データは将来拡張のため構造化（例：発話、感情、アクション）で保持できるようにする。
       * 会話のreset、Appの終了といった基本的コマンドを備える
 * lmstudio仕様
    * OpenAI互換APIへHTTP接続する。
    * 接続不可の場合は、起動・サーバ有効化を自動で行う
 * 実装の思想
    * 今後の拡張性を考慮し、コードファイルは機能単位で分割し、機能間での依存性が高すぎないようにする。

## 詳細設計
 * コマンド仕様（最低限これだけ決める）
    * /exit：終了（ログ保存して終了）
    * /reset：短期履歴をクリア（永続ログは残す or 新セッション開始）
    * /new：新セッション開始（セッションID切替）
    * /save：手動保存（任意）
 * エラー時の振る舞い
    * 生成がタイムアウト時、失敗メッセージを返す
    * プロンプト/履歴が長すぎる場合、古い履歴を捨てる

## 今後考えている拡張
 * 感情をパラメータとして持ち、会話しながら態度を変化させる。
 * Playerの入力を待たずに、無言という状況や入力中という状況も考慮して会話する。
 * GUIにする。
 * Unityと統合し、ゲームにする。
 * 長期的な記憶を持つ。
 * 会話の中でも設定がくみ上げられていく。
 * キャラ設定は別ファイルで管理可能
 * 別途、キャラの過去のエピソード(物語)を管理するファイルも作成する。
 * マルチモーダルにし、入力画像に対しも返答するようにする
 * 複数人とも並列に会話できるようにする
 * 画面にキャラクターを映し、それと連動するようにする。